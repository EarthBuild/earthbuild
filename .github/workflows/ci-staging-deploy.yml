name: staging release

on:
  push:
    branches:
      - 'main'
      - '**-staging-test'
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.github/renovate.json5'
      - '.github/CODEOWNERS'
      - 'LICENSE'

env:
  EARTHLY_REMOTE_CACHE: "earthly-ghcr-cache,image-manifest=true,oci-mediatypes=true,ref=${{ vars.REMOTE_CACHE_REGISTRY }}"

jobs:
  build-earthly:
    permissions: write-all
    uses: ./.github/workflows/build-earthly.yml
    with:
      BUILT_EARTHLY_PATH: "./build/linux/amd64/earthly"
      RUNS_ON: "ubuntu-latest"
      BINARY: "docker"
      SUDO: ""
    secrets: inherit
  prepare-release:
    name: prepare release
    needs: build-earthly
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      packages: write
    outputs:
      release_tag: ${{ steps.compute-tag.outputs.release_tag }}
      version: ${{ steps.compute-version.outputs.version }}
      earthly_next: ${{ steps.read-next.outputs.earthly_next }}
    env:
      FORCE_COLOR: 1
      GITHUB_USER: "earthbuild"
      EARTHLY_REPO: "earthbuild-staging"
      DOCKERHUB_USER: ${{ vars.DOCKERHUB_USERNAME }}
      DOCKERHUB_IMG: "earthbuild-staging"
      DOCKERHUB_BUILDKIT_IMG: "buildkitd-staging"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      - name: Retrieve earthbuild from build-earthly job
        run: |
          BUILDKITD_IMAGE=docker.io/earthbuild/buildkitd-staging TAG=${GITHUB_SHA}-ubuntu-latest-docker ./earthly upgrade
          mkdir -p $(dirname "./build/linux/amd64/earthly")
          mv ${HOME}/.earthly/earthly-${GITHUB_SHA}-ubuntu-latest-docker ./build/linux/amd64/earthly
      - name: Compute release tag
        id: compute-tag
        run: |-
          set -euo pipefail
          RELEASE_TAG="$(git rev-parse --short=8 HEAD)"
          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
      - name: Compute next version
        id: compute-version
        run: |-
          set -euo pipefail
          short_sha=$(git rev-parse --short=8 HEAD)

          # Get all semver tags, extract base version (strip -rc-*, -dev-*, etc), find highest
          # This handles both clean releases (v0.8.16) and RCs (v0.8.17-rc-1) -> base v0.8.17
          highest_base_version=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' | \
            sed 's/\(v[0-9]*\.[0-9]*\.[0-9]*\).*/\1/' | \
            sort -V | tail -1 || echo "")

          if [ -z "$highest_base_version" ]; then
            # No version tags found, start at v0.0.1
            VERSION="v0.0.1-${short_sha}"
          else
            # Check if this exact version has been released (clean tag exists)
            if git tag -l "$highest_base_version" | grep -q "^${highest_base_version}$"; then
              # Clean release exists, increment patch for next version
              major=$(echo "$highest_base_version" | sed 's/v\([0-9]*\)\..*/\1/')
              minor=$(echo "$highest_base_version" | sed 's/v[0-9]*\.\([0-9]*\)\..*/\1/')
              patch=$(echo "$highest_base_version" | sed 's/v[0-9]*\.[0-9]*\.\([0-9]*\)/\1/')
              next_patch=$((patch + 1))
              VERSION="v${major}.${minor}.${next_patch}-${short_sha}"
            else
              # Only RCs exist for this version, use the base version
              VERSION="${highest_base_version}-${short_sha}"
            fi
          fi

          echo "Computed version: $VERSION (highest base: ${highest_base_version:-none})"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      - name: Read earthly-next sha
        id: read-next
        run: |-
          set -euo pipefail
          echo "earthly_next=$(cat earthly-next)" >> "$GITHUB_OUTPUT"

  release-image:
    name: release dockerhub (main)
    needs: [build-earthly, prepare-release]
    runs-on: ubuntu-24.04
    permissions:
      packages: write
      contents: read
    env:
      FORCE_COLOR: 1
      DOCKERHUB_USER: ${{ vars.DOCKERHUB_USERNAME }}
      DOCKERHUB_IMG: "earthbuild-staging"
      DOCKERHUB_BUILDKIT_IMG: "buildkitd-staging"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Set up QEMU
        id: qemu
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3
        with:
          image: tonistiigi/binfmt:latest
          platforms: all
      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  #v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ env.GITHUB_TOKEN }}
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0
      - name: Retrieve earthbuild from build-earthly job
        run: |-
          BUILDKITD_IMAGE=docker.io/earthbuild/buildkitd-staging TAG=${GITHUB_SHA}-ubuntu-latest-docker ./earthly upgrade
          mkdir -p $(dirname "./build/linux/amd64/earthly")
          mv ${HOME}/.earthly/earthly-${GITHUB_SHA}-ubuntu-latest-docker ./build/linux/amd64/earthly
      - name: Release to DockerHub (main)
        env:
          RELEASE_TAG: ${{ needs.prepare-release.outputs.release_tag }}
        run: |-
          set -euo pipefail
          ./build/linux/amd64/earthly --push \
            ./release+release-dockerhub \
            --DOCKERHUB_USER="${{ env.DOCKERHUB_USER }}" \
            --DOCKERHUB_IMG="${{ env.DOCKERHUB_IMG }}" \
            --DOCKERHUB_BUILDKIT_IMG="${{ env.DOCKERHUB_BUILDKIT_IMG }}" \
            --PUSH_PRERELEASE_TAG="true" \
            --PUSH_LATEST_TAG="false" \
            --RELEASE_TAG="${{ env.RELEASE_TAG }}"

  release-ticktock-image:
    name: release dockerhub (ticktock)
    needs: [build-earthly, prepare-release]
    runs-on: ubuntu-24.04
    permissions:
      packages: write
      contents: read
    env:
      FORCE_COLOR: 1
      DOCKERHUB_USER: ${{ vars.DOCKERHUB_USERNAME }}
      DOCKERHUB_IMG: "earthbuild-staging"
      DOCKERHUB_BUILDKIT_IMG: "buildkitd-staging"
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Set up QEMU
        id: qemu
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3
        with:
          image: tonistiigi/binfmt:latest
          platforms: all
      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef  #v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ env.GITHUB_TOKEN }}
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0
      - name: Retrieve earthbuild from build-earthly job
        run: |-
          BUILDKITD_IMAGE=docker.io/earthbuild/buildkitd-staging TAG=${GITHUB_SHA}-ubuntu-latest-docker ./earthly upgrade
          mkdir -p $(dirname "./build/linux/amd64/earthly")
          mv ${HOME}/.earthly/earthly-${GITHUB_SHA}-ubuntu-latest-docker ./build/linux/amd64/earthly
      - name: Release to DockerHub (ticktock)
        env:
          RELEASE_TAG: ${{ needs.prepare-release.outputs.release_tag }}
          EARTHLY_NEXT: ${{ needs.prepare-release.outputs.earthly_next }}
        run: |-
          set -euo pipefail
          ./build/linux/amd64/earthly --push \
            ./release+release-dockerhub \
            --DOCKERHUB_USER="${{ env.DOCKERHUB_USER }}" \
            --DOCKERHUB_IMG="${{ env.DOCKERHUB_IMG }}" \
            --DOCKERHUB_BUILDKIT_IMG="${{ env.DOCKERHUB_BUILDKIT_IMG }}" \
            --PUSH_PRERELEASE_TAG="false" \
            --PUSH_LATEST_TAG="false" \
            --RELEASE_TAG="${{ env.RELEASE_TAG }}-ticktock" \
            --BUILDKIT_PROJECT=github.com/earthbuild/buildkit:${{ env.EARTHLY_NEXT }}

  copy-buildkitd-to-dockerhub:
    name: copy buildkitd to dockerhub
    needs: [build-earthly, prepare-release, release-image]
    runs-on: ubuntu-24.04
    permissions:
      packages: write
    env:
      FORCE_COLOR: 1
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0
      - name: Retrieve earthbuild from build-earthly job
        run: |-
          BUILDKITD_IMAGE=docker.io/earthbuild/buildkitd-staging TAG=${GITHUB_SHA}-ubuntu-latest-docker ./earthly upgrade
          mkdir -p $(dirname "./build/linux/amd64/earthly")
          mv ${HOME}/.earthly/earthly-${GITHUB_SHA}-ubuntu-latest-docker ./build/linux/amd64/earthly
      - name: Copy buildkitd from GHCR to DockerHub
        env:
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          RELEASE_TAG: ${{ needs.prepare-release.outputs.release_tag }}
        run: |-
          set -euo pipefail
          ./build/linux/amd64/earthly --push \
            --secret CONTAINER_REGISTRY_TOKEN=${{ env.GITHUB_TOKEN }} \
            --secret DEST_CONTAINER_REGISTRY_TOKEN=${{ env.DOCKERHUB_TOKEN }} \
            ./release+copy-staging-buildkitd-to-dockerhub \
            --RELEASE_TAG="${{ env.RELEASE_TAG }}" \
            --CONTAINER_REGISTRY_USER="${{ github.actor }}" \
            --DST_CONTAINER_REGISTRY_USER="${{ env.DOCKERHUB_USERNAME }}"

  release-binaries:
    name: release github
    needs: [build-earthly, prepare-release, copy-buildkitd-to-dockerhub]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      packages: write
    env:
      FORCE_COLOR: 1
      GITHUB_USER: "earthbuild"
      EARTHLY_REPO: "earthbuild-staging"
      DOCKERHUB_USER: ${{ vars.DOCKERHUB_USERNAME }}
      DOCKERHUB_BUILDKIT_IMG: "buildkitd-staging"
    steps:
      - name: Set up QEMU
        id: qemu
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3
        with:
          image: tonistiigi/binfmt:latest
          platforms: all
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0
      - name: Retrieve earthbuild from build-earthly job
        run: |-
          BUILDKITD_IMAGE=docker.io/earthbuild/buildkitd-staging TAG=${GITHUB_SHA}-ubuntu-latest-docker ./earthly upgrade
          mkdir -p $(dirname "./build/linux/amd64/earthly")
          mv ${HOME}/.earthly/earthly-${GITHUB_SHA}-ubuntu-latest-docker ./build/linux/amd64/earthly
      # This step creates earthly binaries for all platforms plus signature files for them under
      # the ./release/release/ dir
      - name: Create Release Binaries
        env:
          GPG_PRIVATE: ${{ secrets.GPG_PRIVATE }}
          RELEASE_TAG: ${{ needs.prepare-release.outputs.release_tag }}
          VERSION: ${{ needs.prepare-release.outputs.version }}
        run: |-
          set -euo pipefail
          ./build/linux/amd64/earthly --push \
            --secret GPG_PRIVATE="${{ env.GPG_PRIVATE }}" \
            ./release+signed-release \
            --DOCKERHUB_HOST="docker.io" \
            --GITHUB_USER="${{ env.GITHUB_USER }}" \
            --EARTHLY_REPO="${{ env.EARTHLY_REPO }}" \
            --DOCKERHUB_USER="${{ env.DOCKERHUB_USER }}" \
            --DOCKERHUB_BUILDKIT_IMG="${{ env.DOCKERHUB_BUILDKIT_IMG }}" \
            --RELEASE_TAG="${{ env.RELEASE_TAG }}" \
            --VERSION="${{ env.VERSION }}" \
            --PRERELEASE=false

      - name: Upload Release Binaries Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: ${{ needs.prepare-release.outputs.release_tag }}
          path: release/release/**

