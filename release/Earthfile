VERSION 0.8
FROM alpine:3.23

release-dockerhub:
    ARG --required RELEASE_TAG
    ARG DOCKERHUB_USER="earthly"
    ARG DOCKERHUB_IMG="earthly"
    ARG DOCKERHUB_BUILDKIT_IMG="buildkitd"
    ARG PUSH_LATEST_TAG="false"
    ARG PUSH_PRERELEASE_TAG="false"
    BUILD +perform-release-dockerhub \
          --RELEASE_TAG="$RELEASE_TAG" \
          --DOCKERHUB_USER="$DOCKERHUB_USER" \
          --DOCKERHUB_IMG="$DOCKERHUB_IMG" \
          --DOCKERHUB_BUILDKIT_IMG="$DOCKERHUB_BUILDKIT_IMG" \
          --PUSH_LATEST_TAG="$PUSH_LATEST_TAG" \
          --PUSH_PRERELEASE_TAG="$PUSH_PRERELEASE_TAG"

perform-release-dockerhub:
    ARG --required RELEASE_TAG
    ARG --required PUSH_LATEST_TAG
    ARG --required PUSH_PRERELEASE_TAG
    ARG --required DOCKERHUB_USER
    ARG --required DOCKERHUB_IMG
    ARG --required DOCKERHUB_BUILDKIT_IMG
    BUILD +perform-release-earthly-dockerhub
    BUILD +perform-release-buildkitd-dockerhub

perform-release-earthly-dockerhub:
    ARG --required RELEASE_TAG
    ARG --required PUSH_LATEST_TAG
    ARG --required PUSH_PRERELEASE_TAG
    ARG --required DOCKERHUB_USER
    ARG --required DOCKERHUB_IMG
    ARG --required DOCKERHUB_BUILDKIT_IMG
    ARG BUILDKIT_PROJECT
    BUILD \
        --platform=linux/amd64 \
        --platform=linux/arm64 \
        ../+earthly-docker \
        --TAG="$RELEASE_TAG" \
        --DOCKERHUB_USER="$DOCKERHUB_USER" \
        --DOCKERHUB_IMG="$DOCKERHUB_IMG" \
        --PUSH_LATEST_TAG="$PUSH_LATEST_TAG" \
        --PUSH_PRERELEASE_TAG="$PUSH_PRERELEASE_TAG" \
        --BUILDKIT_PROJECT="$BUILDKIT_PROJECT"

perform-release-buildkitd-dockerhub:
    ARG --required RELEASE_TAG
    ARG --required PUSH_LATEST_TAG
    ARG --required PUSH_PRERELEASE_TAG
    ARG --required DOCKERHUB_USER
    ARG --required DOCKERHUB_IMG
    ARG --required DOCKERHUB_BUILDKIT_IMG
    ARG BUILDKIT_PROJECT
    BUILD \
        --platform=linux/amd64 \
        --platform=linux/arm64 \
        ../buildkitd+buildkitd \
        --TAG="$RELEASE_TAG" \
        --DOCKERHUB_USER="$DOCKERHUB_USER" \
        --DOCKERHUB_BUILDKIT_IMG="$DOCKERHUB_BUILDKIT_IMG" \
        --BUILDKIT_PROJECT="$BUILDKIT_PROJECT"

# signed-release creates the release directory containing binaries for all archs and platforms plus release
# notes and GPG signatures to later zip and upload to github
signed-release:
    FROM alpine:3.23

    RUN apk add file gpg gpg-agent

    ARG --required RELEASE_TAG
    ARG --required GITHUB_USER
    ARG --required EARTHLY_REPO
    ARG --required DOCKERHUB_HOST
    ARG --required DOCKERHUB_USER
    ARG --required DOCKERHUB_BUILDKIT_IMG
    ARG --required PRERELEASE

    # VERSION can be provided explicitly (e.g., for staging builds with semver-style versions)
    # If not provided, defaults to RELEASE_TAG for backwards compatibility
    ARG VERSION="$RELEASE_TAG"

    ARG EARTHLY_GIT_HASH

    COPY (../+earthly-all/* \
         --VERSION=$VERSION \
         --DEFAULT_BUILDKITD_IMAGE="$DOCKERHUB_HOST/$DOCKERHUB_USER/$DOCKERHUB_BUILDKIT_IMG:$RELEASE_TAG" \
         --DEFAULT_INSTALLATION_NAME="earthly" \
         ) ./release/


    RUN test -f ./release/earthly-linux-amd64 && \
        test -f ./release/earthly-darwin-amd64 && \
        test -f ./release/earthly-darwin-arm64 && \
        test -f ./release/earthly-linux-arm64 && \
        test -f ./release/earthly-windows-amd64.exe

    RUN file ./release/earthly-linux-amd64 | grep "x86-64"
    RUN file ./release/earthly-linux-amd64 | grep "ELF 64-bit"
    RUN file ./release/earthly-darwin-amd64 | grep "Mach-O 64-bit x86_64"
    RUN file ./release/earthly-darwin-arm64 | grep "Mach-O 64-bit arm64"
    RUN file ./release/earthly-linux-arm64 | grep "aarch64"
    RUN file ./release/earthly-linux-arm64 | grep "ELF 64-bit"
    RUN file ./release/earthly-windows-amd64.exe | grep "PE32"

    # GPG Sign
    RUN --secret GPG_PRIVATE echo "${GPG_PRIVATE}" | gpg --import && \
        cd release && sha256sum earthly-* > checksum && \
        cat checksum | gpg --default-key earthly-apt -abs --clearsign --no-emit-version > checksum.asc && rm checksum

    SAVE ARTIFACT ./release AS LOCAL ./release

# promote-release is a single target that should be called after creating a GH release that copies all
# releasables (images, artifacts) to their target destinations.
promote-release:
    BUILD +promote-artifacts-to-gh
    BUILD +promote-to-dockerhub

gh-cli:
    FROM alpine:3.23

    RUN apk add --no-cache ca-certificates curl tar jq git bash && update-ca-certificates

    RUN apk add --no-cache github-cli

# release-artifacts-to-gh uploads existing artifacts stored in GitHub actions to a specified release
promote-artifacts-to-gh:
    FROM +gh-cli

    # Built-ins: Full commit SHA, First 8 of commit SHA
    ARG EARTHLY_GIT_HASH

    # Default to earthly-inferred commit SHA but accept an override
    ARG COMMIT_SHA="$EARTHLY_GIT_HASH"

    # Trim COMMIT_SHA to first 8 chars
    LET ARTIFACT_NAME="$(echo $COMMIT_SHA | cut -c1-8)"

    RUN mkdir -p _download

    LET GH_REPO="earthbuild/earthbuild"

    # Download artifact previously built by ci-staging-deploy.yml "Create Release Binaries"
    RUN --secret GITHUB_TOKEN gh run download \
        --name "${ARTIFACT_NAME}" \
        --dir _download

    # The release tag (vX.X.X) that we're running for
    ARG --required RELEASE_TAG

    # Upload all binary artifacts to the existing release. This target is meant to be triggered by creating a
    # release in GitHub
    RUN --push --secret GITHUB_TOKEN find _download -type f -print0 | xargs -0 -n1 -I{} gh release upload "${RELEASE_TAG}" "{}" --clobber

promote-to-dockerhub:
    # Built-ins: First 8 of commit SHA
    ARG EARTHLY_GIT_SHORT_HASH

    # Default to earthly-inferred commit SHA short but accept an override
    ARG COMMIT_SHA_SHORT="$EARTHLY_GIT_SHORT_HASH"

    # The release tag (vX.X.X) that we're running for
    ARG --required RELEASE_TAG

    # ghcr.io/earthbuild/earthbuild:buildkitd-staging-8f307bf7 -> docker.io/earthbuild/buildkitd:${RELEASE_TAG}
    BUILD +copy-img-to-dockerhub --IMG_NAME="buildkitd" --SRC_TAG="buildkitd-staging-${COMMIT_SHA_SHORT}" --RELEASE_TAG="${RELEASE_TAG}"
    # ghcr.io/earthbuild/earthbuild:8f307bf7 -> docker.io/earthbuild/earthbuild:${RELEASE_TAG}
    BUILD +copy-img-to-dockerhub --IMG_NAME="earthbuild" --SRC_TAG="${COMMIT_SHA_SHORT}" --RELEASE_TAG="${RELEASE_TAG}"

    # ghcr.io/earthbuild/earthbuild:buildkitd-staging-8f307bf7-ticktock -> docker.io/earthbuild/buildkitd-ticktock:${RELEASE_TAG}
    BUILD +copy-img-to-dockerhub --IMG_NAME="buildkitd-ticktock" --SRC_TAG="buildkitd-staging-${COMMIT_SHA_SHORT}-ticktock" --RELEASE_TAG="${RELEASE_TAG}"
    # ghcr.io/earthbuild/earthbuild:8f307bf7-ticktock -> docker.io/earthbuild/earthbuild-ticktock:${RELEASE_TAG}
    BUILD +copy-img-to-dockerhub --IMG_NAME="earthbuild-ticktock" --SRC_TAG="${COMMIT_SHA_SHORT}-ticktock" --RELEASE_TAG="${RELEASE_TAG}"

# Copy staging buildkitd from GHCR to DockerHub for staging releases
# This is called during CI staging builds to make the buildkitd image available on DockerHub
# where the staging binaries expect to find it.
copy-staging-buildkitd-to-dockerhub:
    ARG --required RELEASE_TAG
    ARG --required DST_CONTAINER_REGISTRY_USER

    LET SRC_DOCKER_REGISTRY="ghcr.io"
    LET DST_DOCKER_REGISTRY="docker.io"

    # Source: ghcr.io/earthbuild/earthbuild:buildkitd-staging-<commit-sha>
    # Dest: docker.io/earthbuild/buildkitd-staging:<commit-sha>
    LET SRC_IMG="${SRC_DOCKER_REGISTRY}/earthbuild/earthbuild:buildkitd-staging-${RELEASE_TAG}"
    LET DEST_IMG="${DST_DOCKER_REGISTRY}/${DST_CONTAINER_REGISTRY_USER}/buildkitd-staging:${RELEASE_TAG}"

    BUILD +copy-img \
        --SRC_DOCKER_REGISTRY="${SRC_DOCKER_REGISTRY}" \
        --DST_DOCKER_REGISTRY="${DST_DOCKER_REGISTRY}" \
        --SRC_REF="${SRC_IMG}" \
        --DEST_REF="${DEST_IMG}"

copy-img-to-dockerhub:
    ARG --required IMG_NAME
    ARG --required RELEASE_TAG
    ARG --required SRC_TAG

    LET SRC_DOCKER_REGISTRY="ghcr.io"
    LET DST_DOCKER_REGISTRY="docker.io"

    LET SRC_IMG="${SRC_DOCKER_REGISTRY}/earthbuild/earthbuild:${SRC_TAG}"
    LET DEST_IMG="${DST_DOCKER_REGISTRY}/earthbuild/${IMG_NAME}:${RELEASE_TAG}"

    BUILD +copy-img --SRC_DOCKER_REGISTRY="${SRC_DOCKER_REGISTRY}" \
        --DST_DOCKER_REGISTRY="${DST_DOCKER_REGISTRY}" \
        --SRC_REF="${SRC_IMG}" --DEST_REF="${DEST_IMG}"

copy-img:
    FROM +skopeo
    ARG --required SRC_REF
    ARG --required DEST_REF

    ARG --required SRC_DOCKER_REGISTRY
    ARG --required DST_DOCKER_REGISTRY

    RUN --push --no-cache echo "Copying image from '${SRC_REF}' to '${DEST_REF}'"

    ARG --required CONTAINER_REGISTRY_USER
    RUN --secret CONTAINER_REGISTRY_TOKEN=CONTAINER_REGISTRY_TOKEN skopeo login --username "${CONTAINER_REGISTRY_USER}" --password "${CONTAINER_REGISTRY_TOKEN}" "${SRC_DOCKER_REGISTRY}"

    IF [ "$SRC_DOCKER_REGISTRY" != "$DST_DOCKER_REGISTRY" ]
        ARG --required DST_CONTAINER_REGISTRY_USER
        RUN --secret DEST_CONTAINER_REGISTRY_TOKEN skopeo login --username "${DST_CONTAINER_REGISTRY_USER}" --password "${DEST_CONTAINER_REGISTRY_TOKEN}" "${DST_DOCKER_REGISTRY}"
    END

    RUN --push --no-cache skopeo copy --all --insecure-policy docker://${SRC_REF} docker://${DEST_REF}

    RUN --push --no-cache echo "Done copying image from '${SRC_REF}' to '${DEST_REF}'"

skopeo:
    FROM alpine:3.23

    # https://github.com/containers/skopeo/blob/main/install.md#alpine
    RUN apk add skopeo

release-repo:
    ARG --required RELEASE_TAG
    BUILD ./apt-repo+build-and-release --RELEASE_TAG="$RELEASE_TAG"
    BUILD ./yum-repo+build-and-release --RELEASE_TAG="$RELEASE_TAG"
