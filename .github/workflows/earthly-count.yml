name: Track Earthly to Earthbuild Progress

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  count-earthly:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Count occurrences in PR branch
        id: count_pr
        run: |
          # Run detailed counting script
          ./.github/scripts/count-earthly.sh
          
          # The script sets GITHUB_OUTPUT variables
      
      - name: Checkout main branch
        run: |
          git checkout origin/main
      
      - name: Count occurrences in main branch
        id: count_main
        run: |
          # Run detailed counting script
          ./.github/scripts/count-earthly.sh
          
          # Rename output variables for main branch
          mv $GITHUB_OUTPUT temp_output
          sed 's/total_count/main_total_count/g; s/go_count/main_go_count/g; s/md_count/main_md_count/g; s/earthfile_count/main_earthfile_count/g' temp_output > $GITHUB_OUTPUT
          rm temp_output
      
      - name: Calculate difference
        id: calculate
        run: |
          pr_count=${{ steps.count_pr.outputs.total_count }}
          main_count=${{ steps.count_main.outputs.main_total_count }}
          difference=$((main_count - pr_count))
          percentage=0
          
          if [ $main_count -gt 0 ]; then
            percentage=$(echo "scale=2; $difference * 100 / $main_count" | bc)
          fi
          
          echo "difference=$difference" >> $GITHUB_OUTPUT
          echo "percentage=$percentage" >> $GITHUB_OUTPUT
          echo "pr_count=$pr_count" >> $GITHUB_OUTPUT
          echo "main_count=$main_count" >> $GITHUB_OUTPUT
          
          # Calculate differences by type
          go_diff=$((${{ steps.count_main.outputs.main_go_count }} - ${{ steps.count_pr.outputs.go_count }}))
          md_diff=$((${{ steps.count_main.outputs.main_md_count }} - ${{ steps.count_pr.outputs.md_count }}))
          earthfile_diff=$((${{ steps.count_main.outputs.main_earthfile_count }} - ${{ steps.count_pr.outputs.earthfile_count }}))
          
          echo "go_diff=$go_diff" >> $GITHUB_OUTPUT
          echo "md_diff=$md_diff" >> $GITHUB_OUTPUT
          echo "earthfile_diff=$earthfile_diff" >> $GITHUB_OUTPUT
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prCount = ${{ steps.calculate.outputs.pr_count }};
            const mainCount = ${{ steps.calculate.outputs.main_count }};
            const difference = ${{ steps.calculate.outputs.difference }};
            const percentage = ${{ steps.calculate.outputs.percentage }};
            
            // File type differences
            const goDiff = ${{ steps.calculate.outputs.go_diff }};
            const mdDiff = ${{ steps.calculate.outputs.md_diff }};
            const earthfileDiff = ${{ steps.calculate.outputs.earthfile_diff }};
            
            let emoji = '📊';
            let message = '';
            
            if (difference > 0) {
              emoji = '🎉';
              message = `Great progress! You've reduced "earthly" occurrences by **${difference}** (${percentage}%)`;
            } else if (difference < 0) {
              emoji = '⚠️';
              message = `Warning: "earthly" occurrences have increased by **${Math.abs(difference)}**`;
            } else {
              emoji = '➖';
              message = 'No change in "earthly" occurrences';
            }
            
            // Build detailed breakdown
            let breakdown = '';
            if (goDiff !== 0 || mdDiff !== 0 || earthfileDiff !== 0) {
              breakdown = `
            
            ### 📁 Changes by file type:
            | File Type | Change |
            |-----------|--------|
            | Go files (.go) | ${goDiff > 0 ? '✅ -' + goDiff : goDiff < 0 ? '❌ +' + Math.abs(goDiff) : '➖ No change'} |
            | Documentation (.md) | ${mdDiff > 0 ? '✅ -' + mdDiff : mdDiff < 0 ? '❌ +' + Math.abs(mdDiff) : '➖ No change'} |
            | Earthfiles | ${earthfileDiff > 0 ? '✅ -' + earthfileDiff : earthfileDiff < 0 ? '❌ +' + Math.abs(earthfileDiff) : '➖ No change'} |`;
            }
            
            const body = `## ${emoji} Earthly → Earthbuild Progress Report
            
            ${message}
            
            ### 📈 Overall Progress
            | Branch | Total Count |
            |--------|-------------|
            | main   | ${mainCount} |
            | This PR | ${prCount} |
            | **Difference** | **${difference > 0 ? '-' : '+'}${Math.abs(difference)}** ${percentage > 0 ? `(${percentage}%)` : ''} |
            ${breakdown}
            
            ---
            *Keep up the great work migrating from Earthly to Earthbuild!* 🚀
            
            <details>
            <summary>💡 Tips for finding more occurrences</summary>
            
            Run locally to see detailed breakdown:
            \`\`\`bash
            ./.github/scripts/count-earthly.sh
            \`\`\`
            </details>`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Earthly → Earthbuild Progress Report')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }