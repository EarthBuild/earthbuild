{
  $schema: 'https://docs.renovatebot.com/renovate-schema.json',
  extends: [
    'config:recommended',
    'default:pinDigestsDisabled',
    'security:openssf-scorecard',
    ':semanticCommits',
  ],
  baseBranchPatterns: [
    'main',
    'docs-0.8',
  ],
  configMigration: true,
  prHourlyLimit: 1,
  prConcurrentLimit: 3,
  schedule: [ // utc timezone
    'after 4pm on monday',
  ],
  includePaths: [
    'Earthfile',
    '**/go.mod',
    '**/go.sum',
    'docs/**',
    'examples/**',
    '.github/**',
    'release/**',
    'buildcontext/**',
    'earthfile2llb/**',
    'tests/**',
    'scripts/tests/interactive-debugger/**',
    'inputgraph/testdata/**',
    'ast/tests/**',
  ],
  ignorePaths: [
    '**/node_modules/**',
    '**/bower_components/**',
    '**/vendor/**',
    '**/__fixtures__/**',
  ],
  "github-actions": {
    enabled: true
  },
  npm: {
    enabled: true
  },
  "pip_requirements": {
    enabled: true
  },
  bundler: {
    enabled: true
  },
  "docker-compose": {
    enabled: true
  },
  dockerfile: {
    enabled: true,
    managerFilePatterns: [
      '/Earthfile/',
      '/.*\\.earth$/',
      '/Dockerfile*/',
      '/docker-compose*/',
    ],
  },
  customManagers: [
    {
      customType: 'regex',
      managerFilePatterns: [
        '/.+.md/',
      ],
      matchStrings: [
        'earthly/releases/download/(?<currentValue>.+?)/',
        '- uses: earthly/actions/setup-earthly@.*?[\\s\\n]+.*?[\\s\\n]+with:[\\s\\n]*version: (?<currentValue>.+?)[\\s\\n/]+',
        "'earthly/earthly:(?<currentValue>.+?)'",
        'github.com/earthly/earthly:(?<currentValue>.+?)(\\+|`)',
        '(:|\\s+)earthly/earthly:(?<currentValue>.+?)[\\s\\n/]+',
        'the `latest` tag is `(?<currentValue>.+?)`',
        'earthly/compare/(?<currentValue>.+?)\\.\\.\\.main',
        'earthly/satellite:(?<currentValue>.+?)\\n',
      ],
      depNameTemplate: 'earthly/earthly',
      datasourceTemplate: 'github-releases',
    },
    {
      customType: 'regex',
      managerFilePatterns: [
        '/buildcontext/git.go/',
        '/ast/tests/git-clone.ast.json/',
      ],
      matchStrings: [
        '"alpine/git:(?<currentValue>.+?)"',
      ],
      depNameTemplate: 'alpine/git',
      datasourceTemplate: 'docker',
    },
    {
      customType: 'regex',
      description: "Update _version LETs, ARGs and ENVs in Earthfile",
      managerFilePatterns: [
        '/^Earthfile$/',
      ],
      matchStrings: [
        '#\\s*renovate:\\s*datasource=(?<datasource>[a-z-]+?)(?:\\s+depName=(?<depName>.+?))?\\s+packageName=(?<packageName>.+?)(?:\\s+versioning=(?<versioning>[a-z-]+?))?\\s+(?:ENV|ARG|LET)\\s+.+?(_VERSION|_VER|_version)=(?<currentValue>.+?)\\s',
      ],
    },
    {
      customType: 'regex',
      managerFilePatterns: [
        '/Earthfile$/',
        '/earthfile2llb/with_docker_run_base\\.go/',
        '/ast/tests/.*?\\.ast\\.json/',
        '/.+.md/',
      ],
      matchStrings: [
        'ARG(\\s+|\\s+.*?\\s+)DIND_IMAGE=earthbuild/dind:(?<currentValue>.*?)($|\\s|\\n)',
        '--DIND_IMG=earthbuild/dind:(?<currentValue>.*?)($|\\s|\\n|")',
        '("|\\`|\\s+)earthbuild/dind:(?<currentValue>.+?)("|\\`|\\s+\\|)',
        'FROM(\\s+|\\s+.*?\\s+)earthbuild/dind:(?<currentValue>.*?)($|\\s|\\n|\\`)',
        'docker.io/earthbuild/dind:(?<currentValue>.*?)@',
      ],
      depNameTemplate: 'earthbuild/dind',
      datasourceTemplate: 'docker',
    },
    {
      customType: 'regex',
      description: 'Update docker-compose versions in shell scripts',
      managerFilePatterns: [
        '/**/*.sh',
      ],
      matchStrings: [
        '#\\s*renovate:\\s*datasource=(?<datasource>[a-z-]+?)\\s+packageName=(?<packageName>.+?)\\s+curl.*?releases/download/(?<currentValue>[0-9.]+[^/]*)/docker-compose',
      ],
    },

    {
      customType: 'regex',
      description: 'Update Go version in .mise.toml',
      managerFilePatterns: [
        '**/.mise.toml',
      ],
      matchStrings: [
        '^go\\s*=\\s*"(?<currentValue>.+?)"',
      ],
      datasourceTemplate: 'golang-version',
      depNameTemplate: 'go',
    },
    {
      customType: 'regex',
      description: 'Update docker-compose versions in shell scripts',
      managerFilePatterns: [
        '/**/*.sh',
      ],
      matchStrings: [
        '#\\s*renovate:\\s*datasource=(?<datasource>[a-z-]+?)\\s+packageName=(?<packageName>.+?)\\s+curl.*?releases/download/(?<currentValue>[0-9.]+[^/]*)/docker-compose',
      ],
    },
    {
      customType: 'regex',
      description: 'Update Python package versions in requirements.txt',
      managerFilePatterns: [
        '**/requirements.txt',
      ],
      matchStrings: [
        '^(?<depName>[a-zA-Z0-9_-]+)==(?<currentValue>.+?)$',
      ],
      datasourceTemplate: 'pypi',
    },
    {
      customType: 'regex',
      description: 'Update Go version in .mise.toml',
      managerFilePatterns: [
        '**/.mise.toml',
      ],
      matchStrings: [
        '^go\\s*=\\s*"(?<currentValue>.+?)"',
      ],
      datasourceTemplate: 'golang-version',
      depNameTemplate: 'go',
    },
  ],
  labels: [
    'renovate',
  ],
  packageRules: [
    {
      matchPackageNames: [
        'earthly/earthly',
      ],
      matchDatasources: [
        'github-releases',
      ],
      addLabels: [
        'earthly-version-in-docs',
      ],
      schedule: [ // update as soon as possible
        'at any time',
      ],
      automerge: true,
    },
    {
      // Point earthly/earthly updates in docs to docs-0.8 branch by:
      // 1. disable all PRs targeting docs-0.8 for all packages except earthly/earthly
      matchBaseBranches: [
        'docs-0.8',
      ],
      enabled: false,
      matchPackageNames: [
        '!earthly/earthly',
        '!earthbuild/dind',
      ],
    },
    {
      // 2. disable PRs targeting main for earthly/earthly
      matchBaseBranches: [
        'main',
      ],
      matchPackageNames: [
        'earthly/earthly',
      ],
      enabled: false,
    },
    {
      // disable earthly/dind updates in source & tests files for branch docs-0.8
      matchBaseBranches: [
        'docs-0.8',
      ],
      matchFileNames: [
        'Earthfile',
        'earthfile2llb/**',
        'tests/**',
        'scripts/tests/interactive-debugger/**',
        'inputgraph/testdata/**',
        'ast/tests/**',
      ],
      matchPackageNames: [
        'earthbuild/dind',
      ],
      enabled: false,
    },
    {
      // disable earthly/dind updates in docs & examples files for branch main
      matchBaseBranches: [
        'main',
      ],
      matchPackageNames: [
        'earthbuild/dind',
      ],
      matchFileNames: [
        'examples/**',
        'docs/**',
      ],
      enabled: false,
    },
    // group all alpine/git updates across the repo to one PR and schedule it to once a month
    {
      groupName: 'alpine/git',
      matchPackageNames: [
        'alpine/git',
      ],
      schedule: [
        'every month',
      ],
    },
    // group all Dockerfile dependency updates
    {
      matchManagers: [
        'dockerfile',
      ],
      groupName: 'dockerfile-dependencies',
      matchPackageNames: [
        '!alpine/git',
        '!earthbuild/dind',
        '!earthly/earthly',
      ],
      schedule: [
        'every month',
      ],
    },
    {
      // rule to update earthbuild/dind:alpine-* images
      groupName: 'dind-images',
      matchPackageNames: [
        'earthbuild/dind',
      ],
      matchCurrentVersion: '/^alpine-.*/',
      allowedVersions: '/^alpine-.*/',
      versioning: 'regex:^(?<compatibility>.*)-(?<major>\\d+\\.\\d+)-docker-(?<minor>\\d+)\\.(?<patch>\\d+)\\.(?<build>\\d+)-r(?<revision>\\d+)$',
    },
    {
      // rule to update earthbuild/dind:ubuntu:20.04-* images
      groupName: 'dind-images',
      matchPackageNames: [
        'earthbuild/dind',
      ],
      matchCurrentVersion: '/^ubuntu-20\\.04-.*/',
      allowedVersions: '/^ubuntu-20\\.04-.*/',
      versioning: 'regex:^(?<compatibility>.*)-(?<major>\\d+\\.\\d+)-docker-(?<minor>\\d+)\\.(?<patch>\\d+)\\.(?<build>\\d+)-(?<revision>\\d+)$',
    },
    {
      // rule to update earthbuild/dind:ubuntu:23.04-* images
      groupName: 'dind-images',
      matchPackageNames: [
        'earthbuild/dind',
      ],
      matchCurrentVersion: '/^ubuntu-23\\.04-.*/',
      allowedVersions: '/^ubuntu-23\\.04-.*/',
      versioning: 'regex:^(?<compatibility>.*)-(?<major>\\d+\\.\\d+)-docker-(?<minor>\\d+)\\.(?<patch>\\d+)\\.(?<build>\\d+)-(?<revision>\\d+)$',
    },
    // group all examples and docs dependency updates together (except earthly/earthly and earthbuild/dind)
    {
      matchFileNames: [
        '**/.mise.toml',
      ],
      separateMajorMinor: false,
      groupName: 'examples-and-docs-dependencies',
      matchPackageNames: [
        '!earthly/earthly',
        '!earthbuild/dind',
      ],
      schedule: [
        'every month',
      ],
    },
    // group all Node.js dependencies in examples
    {
      matchFileNames: [
        'examples/**/package.json',
        'tests/**/package.json',
      ],
      groupName: 'nodejs-examples-dependencies',
      matchManagers: [
        'npm',
      ],
      schedule: [
        'every month',
      ],
    },
    // group all Python dependencies in examples
    {
      matchFileNames: [
        'examples/**/requirements.txt',
        'tests/**/requirements.txt',
      ],
      groupName: 'python-examples-dependencies',
      matchManagers: [
        'pip_requirements',
      ],
      schedule: [
        'every month',
      ],
    },
    // group all Ruby dependencies in examples
    {
      matchFileNames: [
        'examples/**/Gemfile',
        'tests/**/Gemfile',
      ],
      groupName: 'ruby-examples-dependencies',
      matchManagers: [
        'bundler',
      ],
      schedule: [
        'every month',
      ],
    },
    {
      // group all GitHub Actions updates
      groupName: 'github-actions',
      matchManagers: [
        'github-actions',
      ],
      schedule: [
        'every month',
      ],
    },
    {
      // group all shell script dependency updates
      groupName: 'shell-script-dependencies',
      matchFileNames: [
        '**/*.sh',
      ],
      schedule: [
        'every month',
      ],
    },
    // group all docker-compose dependency updates
    {
      matchManagers: [
        'docker-compose',
      ],
      groupName: 'docker-compose-dependencies',
      schedule: [
        'every month',
      ],
    },
    // group all mise tool version updates
    {
      matchFileNames: [
        '**/.mise.toml',
      ],
      groupName: 'mise-tool-versions',
      schedule: [
        'every month',
      ],
    },
  ],
}
